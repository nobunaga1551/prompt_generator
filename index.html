<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Segoe UI', 'Yu Gothic UI', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh; padding: 20px;
}
.container {
  max-width: 1000px; margin: 0 auto; background: #fff;
  border-radius: 16px; padding: 28px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
}
h1 { font-size: 20px; color: #2d3748; margin-bottom: 4px; }
.subtitle { color: #718096; font-size: 12px; margin-bottom: 20px; }

.opt-panel {
  background: #f7fafc; border: 1.5px solid #e2e8f0;
  border-radius: 10px; padding: 16px 18px; margin-bottom: 18px;
}
.sec-title {
  font-size: 11px; font-weight: 700; color: #718096;
  text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px;
}
.divider { border: none; border-top: 1px solid #e2e8f0; margin: 14px 0; }

.opt-pills { display: flex; flex-wrap: wrap; gap: 8px; }
.pill {
  display: flex; align-items: center; gap: 5px;
  padding: 6px 14px; background: #fff;
  border: 1.5px solid #e2e8f0; border-radius: 20px;
  font-size: 13px; cursor: pointer; transition: all 0.2s; user-select: none;
}
.pill:hover { border-color: #5a67d8; color: #5a67d8; }
.pill.on    { background: #ebf4ff; border-color: #5a67d8; color: #5a67d8; font-weight: 600; }
.pill input { display: none; }

.custom-row {
  display: flex; gap: 8px; align-items: center; margin-bottom: 10px;
}
.custom-row input {
  flex: 1; padding: 7px 12px; border: 1.5px solid #e2e8f0;
  border-radius: 8px; font-size: 13px; font-family: inherit;
  transition: border-color 0.2s;
}
.custom-row input:focus {
  outline: none; border-color: #ed8936;
  box-shadow: 0 0 0 3px rgba(237,137,54,0.15);
}
.btn-add-cst {
  padding: 7px 16px; background: #ed8936; color: #fff;
  border: none; border-radius: 8px; font-size: 13px;
  font-weight: 600; cursor: pointer; font-family: inherit;
  transition: all 0.2s; white-space: nowrap;
}
.btn-add-cst:hover { background: #dd6b20; transform: translateY(-1px); }

.custom-chips { display: flex; flex-wrap: wrap; gap: 7px; min-height: 10px; }
.chip {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 10px 5px 13px;
  background: #fffaf0; border: 1.5px solid #f6ad55;
  border-radius: 20px; font-size: 13px; color: #7b341e; font-weight: 600;
}
.chip-del {
  background: none; border: none; cursor: pointer;
  color: #c05621; font-size: 15px; line-height: 1;
  padding: 0; transition: color 0.15s;
}
.chip-del:hover { color: #9c2600; }
.no-custom { font-size: 12px; color: #a0aec0; font-style: italic; }

table { width: 100%; border-collapse: collapse; }
thead th {
  background: #5a67d8; color: #fff;
  padding: 10px 12px; font-size: 12px; font-weight: 600; text-align: left;
}
thead th:first-child { border-radius: 8px 0 0 0; }
thead th:last-child  { border-radius: 0 8px 0 0; }
tbody tr { transition: background 0.15s; }
tbody tr:nth-child(even) { background: #f7fafc; }
tbody tr:hover { background: #ebf4ff; }
td { padding: 8px; vertical-align: middle; border-bottom: 1px solid #e2e8f0; }

.td-num  { width: 32px; text-align: center; color: #a0aec0; font-size: 12px; }
.td-tag  { width: 200px; vertical-align: top; padding-top: 11px; }
.tag-lbl { font-family: 'Consolas','Courier New',monospace; font-size: 13px; font-weight: 700; color: #2d3748; }
/* âœ… è¿½åŠ ï¼šæ—¥æœ¬èªã‚µãƒ–ãƒ©ãƒ™ãƒ« */
.tag-ja  { font-size: 11px; color: #a0aec0; margin-top: 3px; }

.badge { display: inline-block; font-size: 10px; padding: 1px 7px; border-radius: 10px; margin-top: 3px; }
.req   { background: #c6f6d5; color: #276749; }
.opt   { background: #e9d8fd; color: #6b46c1; }
.cst   { background: #feebc8; color: #7b341e; }

textarea {
  width: 100%; padding: 8px 10px;
  border: 1.5px solid #e2e8f0; border-radius: 6px;
  font-size: 13px; font-family: inherit;
  resize: vertical; min-height: 52px; line-height: 1.5;
  transition: border-color 0.2s;
}
textarea:focus {
  outline: none; border-color: #5a67d8;
  box-shadow: 0 0 0 3px rgba(90,103,216,0.15);
}

.td-action { width: 52px; text-align: center; }
.action-wrap { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.btn-mv {
  width: 26px; height: 26px;
  background: #edf2f7; color: #4a5568;
  border: 1px solid #e2e8f0; border-radius: 4px;
  font-size: 10px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.btn-mv:hover:not(:disabled) { background: #5a67d8; color: #fff; border-color: #5a67d8; }
.btn-mv:disabled { opacity: 0.2; cursor: default; }
.btn-row-del {
  width: 26px; height: 26px; margin-top: 2px;
  background: #fff5f5; color: #e53e3e;
  border: 1px solid #fed7d7; border-radius: 4px;
  font-size: 12px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.btn-row-del:hover { background: #e53e3e; color: #fff; border-color: #e53e3e; }

.toolbar {
  display: flex; gap: 10px; margin: 16px 0 20px;
  align-items: center; flex-wrap: wrap;
}
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 9px 18px; border: none; border-radius: 8px;
  font-size: 13px; font-weight: 600; cursor: pointer;
  font-family: inherit; transition: all 0.2s;
}
.btn:hover { transform: translateY(-1px); }
.btn-save       { background: #e2e8f0; color: #4a5568; }
.btn-save:hover { background: #cbd5e0; }
.btn-save.done  { background: #c6f6d5; color: #276749; }
.btn-reset      { background: #fff; color: #e53e3e; border: 1.5px solid #fed7d7; }
.btn-reset:hover{ background: #fff5f5; }
.btn-gen        { background: #5a67d8; color: #fff; margin-left: auto; }
.btn-gen:hover  { background: #4c51bf; box-shadow: 0 4px 12px rgba(90,103,216,0.4); }
.save-ts        { font-size: 11px; color: #a0aec0; }

.out-card {
  margin-top: 20px; border: 1.5px solid #c6f6d5;
  border-radius: 12px; overflow: hidden; display: none;
}
.out-header {
  background: #f0fff4; padding: 12px 18px;
  display: flex; justify-content: space-between;
  align-items: center; flex-wrap: wrap; gap: 8px;
}
.out-title  { font-weight: 700; color: #276749; font-size: 14px; }
.copy-row   { display: flex; align-items: center; gap: 10px; }
.copy-badge {
  background: #c6f6d5; color: #276749;
  padding: 3px 10px; border-radius: 20px;
  font-size: 12px; font-weight: 600;
  opacity: 0; transition: opacity 0.3s;
}
.copy-badge.on { opacity: 1; }
.btn-copy       { background: #38a169; color: #fff; padding: 10px 22px; font-size: 14px; }
.btn-copy:hover { background: #2f855a; }

#outputText {
  display: block; width: 100%; padding: 14px 18px; border: none;
  font-family: 'Consolas','Courier New',monospace;
  font-size: 13px; line-height: 1.75;
  background: #fafafa; resize: vertical; min-height: 260px; color: #2d3748;
}
#outputText:focus { outline: none; }
.char-count {
  text-align: right; padding: 6px 18px;
  font-size: 12px; color: #718096;
  background: #f7fafc; border-top: 1px solid #e2e8f0;
}

/* â”€â”€ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– (â‰¤640px) â”€â”€ */
@media (max-width: 640px) {
  body { padding: 12px; }
  .container { padding: 16px 14px; border-radius: 12px; }
  h1 { font-size: 17px; }
  .custom-row { flex-direction: column; }
  .btn-add-cst { width: 100%; padding: 10px; }

  table, tbody { display: block; }
  thead        { display: none; }

  tr[data-tag] {
    display: grid;
    grid-template-columns: 1fr auto;
    grid-template-areas: "tag action" "cont cont";
    gap: 8px 10px;
    border: 1.5px solid #e2e8f0; border-radius: 10px;
    margin-bottom: 10px; padding: 12px; background: #fff;
    box-shadow: 0 1px 6px rgba(0,0,0,0.07);
  }
  tbody tr:nth-child(even),
  tbody tr:hover { background: #fff; }
  tr[data-tag] td { border-bottom: none; padding: 0; }

  .td-num     { display: none; }
  .td-tag     { grid-area: tag;    align-self: center; }
  .td-content { grid-area: cont; }
  .td-action  { grid-area: action; align-self: start; }

  textarea { min-height: 90px; font-size: 15px; padding: 10px 12px; }

  .action-wrap  { flex-direction: row; gap: 6px; }
  .btn-mv,
  .btn-row-del  { width: 40px; height: 40px; font-size: 14px; margin-top: 0; }

  .toolbar { flex-direction: column; align-items: stretch; gap: 8px; }
  .btn-save, .btn-reset, .btn-gen { width: 100%; padding: 12px; margin-left: 0; }
  .save-ts { text-align: center; }

  .out-header { flex-direction: column; align-items: stretch; }
  .copy-row   { flex-direction: column; align-items: stretch; }
  .btn-copy   { width: 100%; padding: 12px; }
  #outputText { font-size: 12px; min-height: 200px; }
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸš€ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
  <p class="subtitle">
    å¿…é ˆ(4) + å®šç¾©æ¸ˆã¿ä»»æ„(4) + ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°ï¼ˆè‡ªç”±è¿½åŠ ï¼‰ï¼ â–²â–¼ã§é †ç•ªå¤‰æ›´ ï¼ ğŸ’¾ã§é †ç•ªä¿å­˜
  </p>

  <div class="opt-panel">
    <div class="sec-title">å®šç¾©æ¸ˆã¿ä»»æ„ã‚¿ã‚° â€” ã‚¯ãƒªãƒƒã‚¯ã§ON / OFF</div>
    <div class="opt-pills" id="optPills"></div>
    <hr class="divider">
    <div class="sec-title">ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚° â€” è‡ªç”±ã«è¿½åŠ ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰</div>
    <div class="custom-row">
      <input type="text" id="customInput"
        placeholder="ã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ Enterï¼ˆä¾‹: Audience, Goalâ€¦ï¼‰"
        maxlength="60">
      <button class="btn-add-cst" id="btnAddCst">ï¼‹ è¿½åŠ </button>
    </div>
    <div class="custom-chips" id="customChips"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:32px">#</th>
        <th style="width:200px">ã‚¿ã‚°</th>
        <th>å†…å®¹</th>
        <th style="width:52px; text-align:center">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="toolbar">
    <button class="btn btn-save" id="saveBtn">ğŸ’¾ ã‚¿ã‚°é †ã‚’ä¿å­˜</button>
    <button class="btn btn-reset" id="resetBtn">â†º ãƒªã‚»ãƒƒãƒˆ</button>
    <span class="save-ts" id="saveTs"></span>
    <button class="btn btn-gen" id="genBtn">âš¡ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</button>
  </div>

  <div class="out-card" id="outCard">
    <div class="out-header">
      <span class="out-title">ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</span>
      <div class="copy-row">
        <span class="copy-badge" id="copyBadge">âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</span>
        <button class="btn btn-copy" id="copyBtn">ğŸ“‹ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
    <textarea id="outputText" readonly></textarea>
    <div class="char-count" id="charCount"></div>
  </div>
</div>

<script>
const REQUIRED = ['Objective', 'Persona', 'Instructions', 'Context'];
const OPTIONAL  = ['Constraints', 'Response format', 'Reasoning steps', 'Examples'];

const LS_ORDER  = 'pg_order_v3';
const LS_OPT    = 'pg_opt_v3';
const LS_CUSTOM = 'pg_custom_v3';

// âœ… è¿½åŠ â‘ ï¼šæ—¥æœ¬èªã‚µãƒ–ãƒ©ãƒ™ãƒ«ï¼ˆUIè¡¨ç¤ºç”¨ã®ã¿ï¼‰
const LABELS = {
  'Objective':       'ç›®çš„ãƒ»ã‚´ãƒ¼ãƒ«',
  'Persona':         'å½¹å‰²ãƒ»å°‚é–€æ€§',
  'Instructions':    'å…·ä½“çš„ãªæŒ‡ç¤º',
  'Context':         'èƒŒæ™¯ãƒ»å‰ææƒ…å ±',
  'Constraints':     'åˆ¶ç´„ãƒ»æ¡ä»¶',
  'Response format': 'å‡ºåŠ›å½¢å¼',
  'Reasoning steps': 'æ€è€ƒæ‰‹é †',
  'Examples':        'å…¥å‡ºåŠ›ä¾‹',
};

// âœ… è¿½åŠ â‘¡ï¼šå…¥åŠ›æ¬„ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä¾‹æ–‡
const PLACEHOLDERS = {
  'Objective':
    'ä¾‹ï¼š3æ³Š4æ—¥ã®äº¬éƒ½æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¦ãã ã•ã„',
  'Persona':
    'ä¾‹ï¼šäº¬éƒ½ã«è©³ã—ã„æ—…è¡Œå¥½ããªåœ°å…ƒã®å‹äºº',
  'Instructions':
    'ä¾‹ï¼šé£Ÿäº‹ãƒ»è¦³å…‰ãƒ»ç§»å‹•ã‚’ãƒãƒ©ãƒ³ã‚¹ã‚ˆãå«ã‚ã‚‹ã“ã¨ã€‚è¦³å…‰åœ°ã¯1æ—¥3ç®‡æ‰€ã¾ã§',
  'Context':
    'ä¾‹ï¼š20ä»£ã‚«ãƒƒãƒ—ãƒ«ãƒ»åˆã‚ã¦ã®äº¬éƒ½ãƒ»äºˆç®—ã¯1äººã‚ãŸã‚Š5ä¸‡å††',
  'Constraints':
    'ä¾‹ï¼šæ··é›‘ã™ã‚‹ã‚¹ãƒãƒƒãƒˆã¯é¿ã‘ã‚‹ã€‚ç§»å‹•ã¯é›»è»Šã‹ãƒã‚¹ã®ã¿',
  'Response format':
    'ä¾‹ï¼š1æ—¥ã”ã¨ã«ã€Œåˆå‰ï¼æ˜¼ï¼åˆå¾Œï¼å¤œã€ã®æ™‚ç³»åˆ—ã§ç®‡æ¡æ›¸ã',
  'Reasoning steps':
    'ä¾‹ï¼šâ‘  ç§»å‹•ãƒ«ãƒ¼ãƒˆç¢ºèª â†’ â‘¡ é£Ÿäº‹ã‚¹ãƒãƒƒãƒˆé¸å®š â†’ â‘¢ æ‰€è¦æ™‚é–“ã‚’è¨ˆç®—',
  'Examples':
    'ä¾‹ï¼šå…¥åŠ›ã€Œé›¨ã®æ—¥ã€â†’ å‡ºåŠ›ã€Œå±‹å†…ã‚¹ãƒãƒƒãƒˆå„ªå…ˆãƒ—ãƒ©ãƒ³ï¼šéŒ¦å¸‚å ´ã€äºŒæ¡åŸâ€¦ã€',
};
const DEFAULT_PLACEHOLDER = 'å†…å®¹ã‚’å…¥åŠ›â€¦';

// â”€â”€ XSSå¯¾ç­– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s)
    .replace(/&/g,  '&amp;')
    .replace(/</g,  '&lt;')
    .replace(/>/g,  '&gt;')
    .replace(/"/g,  '&quot;')
    .replace(/'/g,  '&#39;');
}

// â”€â”€ LocalStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let customTags     = loadCustom();
let tagOrder       = loadOrder();
let activeOptional = new Set(loadOpt());

function loadCustom() {
  try {
    const s = JSON.parse(localStorage.getItem(LS_CUSTOM));
    if (Array.isArray(s)) return s.filter(t => typeof t === 'string' && t.trim());
  } catch {}
  return [];
}
function loadOrder() {
  try {
    const s = JSON.parse(localStorage.getItem(LS_ORDER));
    if (Array.isArray(s)) {
      const allKnown = [...REQUIRED, ...OPTIONAL, ...loadCustom()];
      const filtered = s.filter(t => allKnown.includes(t));
      REQUIRED.forEach(t => { if (!filtered.includes(t)) filtered.push(t); });
      return filtered;
    }
  } catch {}
  return [...REQUIRED];
}
function loadOpt() {
  try {
    const s = JSON.parse(localStorage.getItem(LS_OPT));
    if (Array.isArray(s)) return s.filter(t => OPTIONAL.includes(t));
  } catch {}
  return [];
}
function autoSave() {
  localStorage.setItem(LS_CUSTOM, JSON.stringify(customTags));
  localStorage.setItem(LS_ORDER,  JSON.stringify(tagOrder));
}

const isReq = t => REQUIRED.includes(t);
const isOpt = t => OPTIONAL.includes(t);
const isCst = t => customTags.includes(t);

function getVisible() {
  const vis = [];
  tagOrder.forEach(t => {
    if (isReq(t) || activeOptional.has(t) || isCst(t)) vis.push(t);
  });
  REQUIRED.forEach(t => { if (!vis.includes(t)) vis.push(t); });
  return vis;
}

function init() { renderPills(); renderChips(); renderTable(); }

function renderPills() {
  const wrap = document.getElementById('optPills');
  wrap.innerHTML = '';
  OPTIONAL.forEach(tag => {
    const on  = activeOptional.has(tag);
    const lbl = document.createElement('label');
    lbl.className = 'pill' + (on ? ' on' : '');
    lbl.innerHTML = `<input type="checkbox" ${on ? 'checked' : ''}>
      <span>${on ? 'âœ“ ' : ''}${escHtml(tag)}</span>`;
    lbl.querySelector('input').addEventListener('change', e => {
      if (e.target.checked) {
        activeOptional.add(tag);
        if (!tagOrder.includes(tag)) tagOrder.push(tag);
      } else {
        activeOptional.delete(tag);
      }
      renderPills(); renderTable();
    });
    wrap.appendChild(lbl);
  });
}

function renderChips() {
  const wrap = document.getElementById('customChips');
  wrap.innerHTML = '';
  if (customTags.length === 0) {
    wrap.innerHTML = '<span class="no-custom">ã¾ã ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</span>';
    return;
  }
  customTags.forEach(tag => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.innerHTML = `<span>${escHtml(tag)}</span>
      <button class="chip-del" data-tag="${escHtml(tag)}" title="å‰Šé™¤">Ã—</button>`;
    wrap.appendChild(chip);
  });
}

function renderTable() {
  const tbody = document.getElementById('tbody');
  const vis   = getVisible();
  const saved = {};
  tbody.querySelectorAll('tr[data-tag]').forEach(tr => {
    saved[tr.dataset.tag] = tr.querySelector('textarea').value;
  });
  tbody.innerHTML = '';
  vis.forEach((tag, i) => {
    const badgeCls  = isReq(tag) ? 'req' : isOpt(tag) ? 'opt' : 'cst';
    const badgeLbl  = isReq(tag) ? 'å¿…é ˆ' : isOpt(tag) ? 'ä»»æ„' : 'ã‚«ã‚¹ã‚¿ãƒ ';
    // âœ… æ—¥æœ¬èªãƒ©ãƒ™ãƒ«ã¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å–å¾—
    const jaLabel   = LABELS[tag] || '';
    const phText    = PLACEHOLDERS[tag] || DEFAULT_PLACEHOLDER;

    const tr = document.createElement('tr');
    tr.dataset.tag = tag;
    tr.innerHTML = `
      <td class="td-num">${i + 1}</td>
      <td class="td-tag">
        <div class="tag-lbl">&lt;${escHtml(tag)}&gt;</div>
        <span class="badge ${badgeCls}">${badgeLbl}</span>
        ${jaLabel ? `<div class="tag-ja">${escHtml(jaLabel)}</div>` : ''}
      </td>
      <td class="td-content">
        <textarea placeholder="${escHtml(phText)}"></textarea>
      </td>
      <td class="td-action">
        <div class="action-wrap">
          <button class="btn-mv" data-dir="-1" ${i === 0 ? 'disabled' : ''}>â–²</button>
          <button class="btn-mv" data-dir="1"  ${i === vis.length - 1 ? 'disabled' : ''}>â–¼</button>
          ${isCst(tag) ? '<button class="btn-row-del" title="å‰Šé™¤">Ã—</button>' : ''}
        </div>
      </td>`;
    if (saved[tag]) tr.querySelector('textarea').value = saved[tag];
    tbody.appendChild(tr);
  });
}

function moveRow(tag, dir) {
  const vis = getVisible();
  const i   = vis.indexOf(tag);
  const j   = i + dir;
  if (j < 0 || j >= vis.length) return;
  const pi = tagOrder.indexOf(vis[i]);
  const pj = tagOrder.indexOf(vis[j]);
  [tagOrder[pi], tagOrder[pj]] = [tagOrder[pj], tagOrder[pi]];
  renderTable();
}

function addCustom() {
  const input = document.getElementById('customInput');
  const name  = input.value.trim();
  if (!name) return;
  const all = [...REQUIRED, ...OPTIONAL, ...customTags];
  if (all.some(t => t.toLowerCase() === name.toLowerCase())) {
    alert(`"${name}" ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚`); return;
  }
  customTags.push(name);
  if (!tagOrder.includes(name)) tagOrder.push(name);
  autoSave();
  input.value = '';
  renderChips(); renderTable();
}

function removeCustom(name) {
  if (!confirm(`ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚° "${name}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  customTags = customTags.filter(t => t !== name);
  tagOrder   = tagOrder.filter(t => t !== name);
  autoSave();
  renderChips(); renderTable();
}

function saveOrder() {
  localStorage.setItem(LS_ORDER, JSON.stringify(tagOrder));
  localStorage.setItem(LS_OPT,   JSON.stringify([...activeOptional]));
  const btn = document.getElementById('saveBtn');
  btn.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸ';
  btn.classList.add('done');
  document.getElementById('saveTs').textContent =
    new Date().toLocaleTimeString('ja-JP') + ' ã«ä¿å­˜';
  setTimeout(() => { btn.textContent = 'ğŸ’¾ ã‚¿ã‚°é †ã‚’ä¿å­˜'; btn.classList.remove('done'); }, 2000);
}

function resetOrder() {
  if (!confirm('ã‚¿ã‚°ã®é †ç•ªãƒ»ä»»æ„ã‚¿ã‚°ãƒ»ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  [LS_ORDER, LS_OPT, LS_CUSTOM].forEach(k => localStorage.removeItem(k));
  customTags = []; tagOrder = [...REQUIRED]; activeOptional = new Set();
  document.getElementById('saveTs').textContent = '';
  renderPills(); renderChips(); renderTable();
}

function generate() {
  let result = '';
  document.querySelectorAll('#tbody tr[data-tag]').forEach(tr => {
    const tag     = tr.dataset.tag;
    const content = tr.querySelector('textarea').value.trim();
    result += `<${tag}>\n${content}\n</${tag}>\n\n`;
  });
  result = result.replace(/\n+$/, '');
  if (!result.trim()) { alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
  document.getElementById('outputText').value = result;
  document.getElementById('charCount').textContent =
    `æ–‡å­—æ•°: ${result.length.toLocaleString()} æ–‡å­—`;
  const card = document.getElementById('outCard');
  card.style.display = 'block';
  card.scrollIntoView({ behavior: 'smooth', block: 'start' });
  clip(result, true);
}

function clip(text, auto) {
  navigator.clipboard.writeText(text)
    .then(() => feedback(auto))
    .catch(() => {
      document.getElementById('outputText').select();
      document.execCommand('copy');
      feedback(auto);
    });
}
function feedback(auto) {
  if (!auto) {
    const b = document.getElementById('copyBadge');
    b.classList.add('on');
    setTimeout(() => b.classList.remove('on'), 2500);
  }
  const btn = document.getElementById('copyBtn');
  btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼æ¸ˆã¿ï¼';
  setTimeout(() => btn.textContent = 'ğŸ“‹ ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚³ãƒ”ãƒ¼', 2000);
}

document.getElementById('tbody').addEventListener('click', e => {
  const row = e.target.closest('tr[data-tag]');
  if (!row) return;
  const tag = row.dataset.tag;
  if (e.target.classList.contains('btn-mv'))      moveRow(tag, Number(e.target.dataset.dir));
  if (e.target.classList.contains('btn-row-del')) removeCustom(tag);
});
document.getElementById('customChips').addEventListener('click', e => {
  if (e.target.classList.contains('chip-del')) removeCustom(e.target.dataset.tag);
});
document.getElementById('customInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') addCustom();
});
document.getElementById('btnAddCst').addEventListener('click', addCustom);
document.getElementById('saveBtn').addEventListener('click', saveOrder);
document.getElementById('resetBtn').addEventListener('click', resetOrder);
document.getElementById('genBtn').addEventListener('click', generate);
document.getElementById('copyBtn').addEventListener('click', () =>
  clip(document.getElementById('outputText').value, false));

init();
</script>
</body>
</html>
